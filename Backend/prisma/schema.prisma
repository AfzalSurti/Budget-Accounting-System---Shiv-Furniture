// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

//
// Enums (keep statuses strict + production safe)
//
enum ContactType {   // for contatc details used in purchase order / sales order / vendor bill / customer invoice
  customer
  vendor
  both
  internal
}

enum DocStatus { 
  draft
  posted
  cancelled
}

enum OrderStatus {
  draft
  confirmed
  cancelled
  done
}

enum BudgetStatus {
  draft
  approved
  archived
}

enum JournalStatus {
  draft
  posted
  void
}

enum JournalSourceType {
  vendor_bill
  customer_invoice
  payment
  manual
}

enum PaymentDirection {
  inbound
  outbound
}

enum PaymentStatus {
  draft
  posted
  void
}

enum PaymentMethod {
  cash
  bank
  upi
  card
  online
  other
}

enum AllocationTargetType {
  customer_invoice
  vendor_bill
}

enum DocOwnerType {
  customer_invoice
  vendor_bill
  sales_order
  purchase_order
}

enum AutoDocType {
  vendor_bill
  customer_invoice
  purchase_order
  sales_order
}

enum AccountType {
  asset
  liability
  equity
  income
  expense
}

enum UserRole {
  ADMIN
  PORTAL
}


model Company {  // all details of a company using the system
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  contacts          Contact[]
  productCategories ProductCategory[]
  products          Product[]
  analyticAccounts  AnalyticAccount[]
  glAccounts        GLAccount[]
  journalEntries    JournalEntry[]
  budgets           Budget[]
  autoAnalyticModels AutoAnalyticModel[]
  purchaseOrders    PurchaseOrder[]
  salesOrders       SalesOrder[]
  vendorBills       VendorBill[]
  customerInvoices  CustomerInvoice[]
  payments          Payment[]
  documentFiles     DocumentFile[]

  @@map("companies")
}

model Contact {  // contact details of customers and vendors
  id                  String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String      @db.Uuid @map("company_id") 
  contactType         ContactType @map("contact_type")
  displayName         String      @map("display_name")
  email               String?          
  phone               String?
  gstin               String?
  billingAddress      Json?       @map("billing_address")
  shippingAddress     Json?       @map("shipping_address")
  isPortalUser        Boolean     @default(false) @map("is_portal_user")
  portalUserExternalId String?    @map("portal_user_external_id")
  isActive            Boolean     @default(true) @map("is_active")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @default(now()) @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  vendorPurchaseOrders  PurchaseOrder[]  @relation("po_vendor")
  customerSalesOrders   SalesOrder[]     @relation("so_customer")
  vendorBills           VendorBill[]     @relation("bill_vendor")
  customerInvoices      CustomerInvoice[] @relation("inv_customer")
  payments              Payment[]
  journalLines          JournalLine[]
  autoAnalyticRules     AutoAnalyticRule[]
  users                User[]

  @@unique([companyId, email])
  @@index([companyId, contactType])
  @@index([companyId, isPortalUser])
  @@map("contacts")
}

model ProductCategory {  // hierarchical product categories
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @db.Uuid @map("company_id")
  name      String
  parentId  String?  @db.Uuid @map("parent_id")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  parent   ProductCategory? @relation("cat_parent", fields: [parentId], references: [id])
  children ProductCategory[] @relation("cat_parent")

  products Product[]
  autoAnalyticRules AutoAnalyticRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("product_categories")
}

model Product {  // products / services sold or purchased
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String   @db.Uuid @map("company_id")
  sku        String?
  name       String
  categoryId String?  @db.Uuid @map("category_id")
  uom        String   @default("unit")
  salePrice  Decimal  @default(0) @db.Decimal(18, 2) @map("sale_price")
  costPrice  Decimal  @default(0) @db.Decimal(18, 2) @map("cost_price")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category ProductCategory? @relation(fields: [categoryId], references: [id])

  poLines  PurchaseOrderLine[]
  soLines  SalesOrderLine[]
  billLines VendorBillLine[]
  invLines  CustomerInvoiceLine[]
  journalLines JournalLine[]
  autoAnalyticRules AutoAnalyticRule[]

  @@unique([companyId, sku])
  @@index([companyId, categoryId])
  @@map("products")
}

model AnalyticAccount {  // for tracking expenses/incomes across various dimensions
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @db.Uuid @map("company_id")
  code      String?
  name      String
  parentId  String?  @db.Uuid @map("parent_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  parent   AnalyticAccount? @relation("aa_parent", fields: [parentId], references: [id])
  children AnalyticAccount[] @relation("aa_parent")

  budgetLines BudgetLine[]
  journalLines JournalLine[]
  poLines  PurchaseOrderLine[]
  soLines  SalesOrderLine[]
  billLines VendorBillLine[]
  invLines  CustomerInvoiceLine[]
  autoAnalyticRules AutoAnalyticRule[]

  @@unique([companyId, code])
  @@unique([companyId, name])
  @@index([companyId])
  @@map("analytic_accounts")
}

model GLAccount {  // general ledger accounts for accounting
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String     @db.Uuid @map("company_id")
  code       String
  name       String
  accountType AccountType @map("account_type")
  isActive   Boolean    @default(true) @map("is_active")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  journalLines JournalLine[]
  budgetLines  BudgetLine[]
  billLines    VendorBillLine[]
  invLines     CustomerInvoiceLine[]

  @@unique([companyId, code])
  @@map("gl_accounts")
}

model JournalEntry {  // journal entries for recording financial transactions 
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String          @db.Uuid @map("company_id")
  entryDate  DateTime        @db.Date @map("entry_date")
  status     JournalStatus
  sourceType JournalSourceType @map("source_type")
  sourceId   String?         @db.Uuid @map("source_id")
  memo       String?
  createdAt  DateTime        @default(now()) @map("created_at")
  postedAt   DateTime?       @map("posted_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines   JournalLine[]

  @@index([companyId, entryDate])
  @@index([companyId, status])
  @@index([companyId, sourceType, sourceId])
  @@map("journal_entries")
}

model JournalLine {  // individual lines within a journal entry
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  journalEntryId String   @db.Uuid @map("journal_entry_id")
  glAccountId    String   @db.Uuid @map("gl_account_id")
  analyticAccountId String? @db.Uuid @map("analytic_account_id")
  contactId      String?  @db.Uuid @map("contact_id")
  productId      String?  @db.Uuid @map("product_id")
  description    String?
  debit          Decimal  @default(0) @db.Decimal(18, 2)
  credit         Decimal  @default(0) @db.Decimal(18, 2)

  entry   JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  gl      GLAccount      @relation(fields: [glAccountId], references: [id])
  analytic AnalyticAccount? @relation(fields: [analyticAccountId], references: [id])
  contact Contact?       @relation(fields: [contactId], references: [id])
  product Product?       @relation(fields: [productId], references: [id])

  @@index([journalEntryId])
  @@index([analyticAccountId])
  @@index([glAccountId])
  @@map("journal_lines")
}

model Budget {  // budgets for financial planning
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String      @db.Uuid @map("company_id")
  name        String
  periodStart DateTime    @db.Date @map("period_start")
  periodEnd   DateTime    @db.Date @map("period_end")
  status      BudgetStatus
  createdBy   String?     @db.Uuid @map("created_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  approvedAt  DateTime?   @map("approved_at")

  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  revisions BudgetRevision[]

  @@index([companyId, periodStart, periodEnd])
  @@index([companyId, status])
  @@map("budgets")
}

model BudgetRevision {  // tracks changes to budget lines over time
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  budgetId        String   @db.Uuid @map("budget_id")
  revisionNo      Int      @map("revision_no")
  revisionReason  String?  @map("revision_reason")
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       String?  @db.Uuid @map("created_by")

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  lines  BudgetLine[]

  @@unique([budgetId, revisionNo])
  @@map("budget_revisions")
}

model BudgetLine {  // individual lines within a budget revision
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  budgetRevisionId String  @db.Uuid @map("budget_revision_id")
  analyticAccountId String @db.Uuid @map("analytic_account_id")
  glAccountId      String? @db.Uuid @map("gl_account_id")
  amount           Decimal @db.Decimal(18, 2)

  revision BudgetRevision @relation(fields: [budgetRevisionId], references: [id], onDelete: Cascade)
  analytic AnalyticAccount @relation(fields: [analyticAccountId], references: [id])
  gl       GLAccount? @relation(fields: [glAccountId], references: [id])

  @@unique([budgetRevisionId, analyticAccountId, glAccountId])
  @@index([analyticAccountId])
  @@index([budgetRevisionId])
  @@map("budget_lines")
}

model AutoAnalyticModel {  // models for automatically assigning analytic accounts based on rules
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @db.Uuid @map("company_id")
  name      String
  priority  Int      @default(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rules   AutoAnalyticRule[]

  @@map("auto_analytic_models")
}

model AutoAnalyticRule {  // rules for automatically assigning analytic accounts based on conditions
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelId   String    @db.Uuid @map("model_id")
  docType   AutoDocType @map("doc_type")
  matchProductId  String? @db.Uuid @map("match_product_id")
  matchCategoryId String? @db.Uuid @map("match_category_id")
  matchContactId  String? @db.Uuid @map("match_contact_id")
  assignAnalyticAccountId String @db.Uuid @map("assign_analytic_account_id")
  rulePriority Int @default(100) @map("rule_priority")
  isActive   Boolean @default(true) @map("is_active")

  model   AutoAnalyticModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [matchProductId], references: [id])
  category ProductCategory? @relation(fields: [matchCategoryId], references: [id])
  contact Contact? @relation(fields: [matchContactId], references: [id])
  assignAnalytic AnalyticAccount @relation(fields: [assignAnalyticAccountId], references: [id])

  @@index([docType, isActive, rulePriority])
  @@map("auto_analytic_rules")
}

model PurchaseOrder {  // purchase orders from vendors
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String     @db.Uuid @map("company_id")
  poNo      String     @map("po_no")
  vendorId  String     @db.Uuid @map("vendor_id")
  orderDate DateTime   @db.Date @map("order_date")
  status    OrderStatus
  currency  String     @default("INR")
  notes     String?
  createdAt DateTime   @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor  Contact @relation("po_vendor", fields: [vendorId], references: [id])
  lines   PurchaseOrderLine[]
  bills   VendorBill[]

  @@unique([companyId, poNo])
  @@map("purchase_orders")
}

model PurchaseOrderLine { // individual lines within a purchase order
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  purchaseOrderId String   @db.Uuid @map("purchase_order_id")
  productId       String   @db.Uuid @map("product_id")
  analyticAccountId String? @db.Uuid @map("analytic_account_id")
  description     String?
  qty             Decimal  @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 2) @map("unit_price")
  taxRate         Decimal  @default(0) @db.Decimal(6, 3) @map("tax_rate")
  lineTotal       Decimal  @db.Decimal(18, 2) @map("line_total")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])
  analytic      AnalyticAccount? @relation(fields: [analyticAccountId], references: [id])

  @@index([purchaseOrderId])
  @@index([analyticAccountId])
  @@map("purchase_order_lines")
}

model SalesOrder {  // sales orders to customers
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String     @db.Uuid @map("company_id")
  soNo      String     @map("so_no")
  customerId String    @db.Uuid @map("customer_id")
  orderDate DateTime   @db.Date @map("order_date")
  status    OrderStatus
  currency  String     @default("INR")
  notes     String?
  createdAt DateTime   @default(now()) @map("created_at")

  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Contact @relation("so_customer", fields: [customerId], references: [id])
  lines    SalesOrderLine[]
  invoices CustomerInvoice[]

  @@unique([companyId, soNo])
  @@map("sales_orders")
}

model SalesOrderLine { // individual lines within a sales order
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  salesOrderId String  @db.Uuid @map("sales_order_id")
  productId    String  @db.Uuid @map("product_id")
  analyticAccountId String? @db.Uuid @map("analytic_account_id")
  description  String?
  qty          Decimal  @db.Decimal(18, 4)
  unitPrice    Decimal  @db.Decimal(18, 2) @map("unit_price")
  taxRate      Decimal  @default(0) @db.Decimal(6, 3) @map("tax_rate")
  lineTotal    Decimal  @db.Decimal(18, 2) @map("line_total")

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])
  analytic   AnalyticAccount? @relation(fields: [analyticAccountId], references: [id])

  @@index([salesOrderId])
  @@index([analyticAccountId])
  @@map("sales_order_lines")
}

model VendorBill { // vendor bills from suppliers
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId    String   @db.Uuid @map("company_id")
  billNo       String   @map("bill_no")
  vendorId     String   @db.Uuid @map("vendor_id")
  billDate     DateTime @db.Date @map("bill_date")
  dueDate      DateTime? @db.Date @map("due_date")
  status       DocStatus
  currency     String   @default("INR")
  poId         String?  @db.Uuid @map("po_id")
  totalAmount  Decimal  @default(0) @db.Decimal(18, 2) @map("total_amount")
  paidAmount   Decimal  @default(0) @db.Decimal(18, 2) @map("paid_amount")
  paymentState String   @default("not_paid") @map("payment_status")
  createdAt    DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor  Contact @relation("bill_vendor", fields: [vendorId], references: [id])
  po      PurchaseOrder? @relation(fields: [poId], references: [id])
  lines   VendorBillLine[]

  @@unique([companyId, billNo])
  @@index([companyId, vendorId, billDate])
  @@index([companyId, status])
  @@map("vendor_bills")
}

model VendorBillLine {  // individual lines within a vendor bill
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorBillId  String  @db.Uuid @map("vendor_bill_id")
  productId     String? @db.Uuid @map("product_id")
  analyticAccountId String? @db.Uuid @map("analytic_account_id")
  glAccountId   String? @db.Uuid @map("gl_account_id")
  description   String?
  qty           Decimal @default(1) @db.Decimal(18, 4)
  unitPrice     Decimal @db.Decimal(18, 2) @map("unit_price")
  taxRate       Decimal @default(0) @db.Decimal(6, 3) @map("tax_rate")
  lineTotal     Decimal @db.Decimal(18, 2) @map("line_total")

  bill     VendorBill @relation(fields: [vendorBillId], references: [id], onDelete: Cascade)
  product  Product?   @relation(fields: [productId], references: [id])
  analytic AnalyticAccount? @relation(fields: [analyticAccountId], references: [id])
  gl       GLAccount? @relation(fields: [glAccountId], references: [id])

  @@index([vendorBillId])
  @@index([analyticAccountId])
  @@map("vendor_bill_lines")
}

model CustomerInvoice {  // customer invoices for billing
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId     String   @db.Uuid @map("company_id")
  invoiceNo     String   @map("invoice_no")
  customerId    String   @db.Uuid @map("customer_id")
  invoiceDate   DateTime @db.Date @map("invoice_date")
  dueDate       DateTime? @db.Date @map("due_date")
  status        DocStatus
  currency      String   @default("INR")
  soId          String?  @db.Uuid @map("so_id")
  totalAmount   Decimal  @default(0) @db.Decimal(18, 2) @map("total_amount")
  paidAmount    Decimal  @default(0) @db.Decimal(18, 2) @map("paid_amount")
  paymentState  String   @default("not_paid") @map("payment_status")
  portalVisible Boolean  @default(true) @map("portal_visible")
  createdAt     DateTime @default(now()) @map("created_at")

  company  Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Contact    @relation("inv_customer", fields: [customerId], references: [id])
  so       SalesOrder? @relation(fields: [soId], references: [id])
  lines    CustomerInvoiceLine[]

  @@unique([companyId, invoiceNo])
  @@index([companyId, customerId, invoiceDate])
  @@index([companyId, status])
  @@map("customer_invoices")
}

model CustomerInvoiceLine { // individual lines within a customer invoice
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerInvoiceId String @db.Uuid @map("customer_invoice_id")
  productId         String? @db.Uuid @map("product_id")
  analyticAccountId String? @db.Uuid @map("analytic_account_id")
  glAccountId       String? @db.Uuid @map("gl_account_id")
  description       String?
  qty               Decimal @default(1) @db.Decimal(18, 4)
  unitPrice         Decimal @db.Decimal(18, 2) @map("unit_price")
  taxRate           Decimal @default(0) @db.Decimal(6, 3) @map("tax_rate")
  lineTotal         Decimal @db.Decimal(18, 2) @map("line_total")

  invoice  CustomerInvoice @relation(fields: [customerInvoiceId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id])
  analytic AnalyticAccount? @relation(fields: [analyticAccountId], references: [id])
  gl       GLAccount? @relation(fields: [glAccountId], references: [id])

  @@index([customerInvoiceId])
  @@index([analyticAccountId])
  @@map("customer_invoice_lines")
}

model Payment { // payments made or received
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String          @db.Uuid @map("company_id")
  direction  PaymentDirection
  contactId  String          @db.Uuid @map("contact_id")
  paymentDate DateTime       @db.Date @map("payment_date")
  method     PaymentMethod
  reference  String?
  amount     Decimal         @db.Decimal(18, 2)
  status     PaymentStatus
  createdAt  DateTime        @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id])
  allocations PaymentAllocation[]

  @@index([companyId, paymentDate])
  @@index([companyId, contactId])
  @@map("payments")
}

model PaymentAllocation { // allocations of payments to invoices or bills
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentId String  @db.Uuid @map("payment_id")
  targetType AllocationTargetType @map("target_type")
  targetId  String  @db.Uuid @map("target_id")
  amount    Decimal @db.Decimal(18, 2)

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([paymentId, targetType, targetId])
  @@index([targetType, targetId])
  @@map("payment_allocations")
}

model DocumentFile {  // files attached to various documents
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @db.Uuid @map("company_id")
  ownerType DocOwnerType @map("owner_type")
  ownerId   String   @db.Uuid @map("owner_id")
  fileName  String   @map("file_name")
  mimeType  String   @map("mime_type")
  storageUrl String  @map("storage_url")
  createdAt DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, ownerType, ownerId])
  @@map("document_files")
}

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String   @unique
  loginId      String   @unique @map("login_id") @db.Char(6)
  passwordHash String   @map("password_hash")
  role         UserRole @default(ADMIN)
  contactId    String?  @db.Uuid @map("contact_id")
  isActive     Boolean  @default(true) @map("is_active")
  tokenVersion Int      @default(0) @map("token_version")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  contact Contact? @relation(fields: [contactId], references: [id])
  auditLogs AuditLog[]

  @@map("users")
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @db.Uuid @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId, entity])
  @@map("audit_logs")
}
